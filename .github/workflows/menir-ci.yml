name: Menir CI Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  menir-full-check:
    runs-on: ubuntu-latest
    env:
      NEO4J_URI: ${{ secrets.NEO4J_URI }}
      NEO4J_USER: ${{ secrets.NEO4J_USER }}
      NEO4J_PWD: ${{ secrets.NEO4J_PWD }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install neo4j python-dotenv trufflehog3

      - name: Healthcheck Neo4j
        # Fails if Neo4j is not accessible.
        # Note: Needs a reachable NEO4J_URI (e.g. AuraDB). Localhost won't work in CI unless you spin up a service container.
        run: |
          python scripts/menir_healthcheck_cli.py

      # Optional: ingest data (comente se não quiser rodar no CI)
      - name: Ingest data
        run: |
          if [ -f ingest/run_ingest_all.py ]; then
            python ingest/run_ingest_all.py
          else
            echo "No ingest script present — skipping ingest."
          fi

      - name: Clean old logs
        run: |
          python scripts/clean_logs.py

      - name: Secrets scan — Gitleaks
        run: |
          echo "Installing Gitleaks..."
          curl -sSL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks-linux-amd64.tar.gz | tar -xz -C .
          chmod +x gitleaks
          ./gitleaks detect --source . --exit-code 1 --report-path=gitleaks-report.json

      - name: Secrets scan — TruffleHog (optional)
        run: |
          # Already installed in setup step or here
          trufflehog filesystem . --entropy True > trufflehog-report.txt || echo "Truffle scan completed"

      # Placeholder for graph dump/back-up — ajustar conforme script real
      - name: Dump graph (placeholder)
        run: |
          echo "No dump script configured — skipping dump."

      # Optional commit/push excluded for safety by default
