name: GatoMia Dashboard

on:
  workflow_dispatch:
  push:
    paths:
      - "projects/Gatomia/gatomia_dashboard.cypher"
      - "projects/Reflexive/setup_reflexive_layer.cypher"

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Neo4j Cypher Shell
        run: |
          wget -q https://dist.neo4j.org/cypher-shell/cypher-shell-5.23.0.zip
          unzip -q cypher-shell-5.23.0.zip
          echo "$PWD/cypher-shell-5.23.0/bin" >> $GITHUB_PATH

      - name: Apply Reflexive Layer
        env:
          NEO4J_URI: ${{ secrets.NEO4J_URI }}
          NEO4J_USER: ${{ secrets.NEO4J_USER }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
        run: |
          cypher-shell -a "$NEO4J_URI" -u "$NEO4J_USER" -p "$NEO4J_PASSWORD" -f projects/Reflexive/setup_reflexive_layer.cypher

      - name: Run GatoMia Dashboard
        env:
          NEO4J_URI: ${{ secrets.NEO4J_URI }}
          NEO4J_USER: ${{ secrets.NEO4J_USER }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
        run: |
          cypher-shell -a "$NEO4J_URI" -u "$NEO4J_USER" -p "$NEO4J_PASSWORD" -f projects/Gatomia/gatomia_dashboard.cypher

          - name: Log Commit no MENIR Core
        env:
    
  run: |
    cypher-shell -a "$NEO4J_URI" -u "$NEO4J_USER" -p "$NEO4J_PASSWORD" \
      -P commit_id="$COMMIT_ID" \
      -P msg="$COMMIT_MSG" \
      -P autor="$AUTHOR" \
      -P arquivos='${{ toJson(github.event.head_commit.added) }}' \
      -P data=$(date +%F) \
      -f projects/Core/core_commitlog.cypher
          - name: Log Commit no MENIR Core
  env:
    NEO4J_URI: ${{ secrets.NEO4J_URI }}
    NEO4J_USER: ${{ secrets.NEO4J_USER }}
    NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
    COMMIT_ID: ${{ github.sha }}
    COMMIT_MSG: ${{ github.event.head_commit.message }}
    AUTHOR: ${{ github.actor }}
  run: |
    cypher-shell -a "$NEO4J_URI" -u "$NEO4J_USER" -p "$NEO4J_PASSWORD" \
      -P commit_id="$COMMIT_ID" \
      -P msg="$COMMIT_MSG" \
      -P autor="$AUTHOR" \
      -P arquivos='${{ toJson(github.event.head_commit.added) }}' \
      -P data=$(date +%F) \
      -f projects/Core/core_commitlog.cypher
