#!/usr/bin/env pwsh
# PowerShell script: .githooks/post-commit

$RepoRoot = git rev-parse --show-toplevel
$CheckpointsDir = Join-Path $RepoRoot "checkpoints"
$TS = Get-Date -Format "yyyy-MM-ddTHH-mm-ss"
$HASH = git rev-parse --short HEAD

if (-not (Test-Path $CheckpointsDir)) {
    New-Item -ItemType Directory -Path $CheckpointsDir | Out-Null
}

# Verifica se houve mudança em cypher/
$changed = git diff-tree --no-commit-id --name-only -r HEAD | Select-String '^cypher/'

if ($changed) {
    $File = Join-Path $CheckpointsDir "checkpoint_${TS}_${HASH}.md"
    $author = git config user.name
    $msg = git log -1 --pretty=%B

    @"
# Checkpoint — $TS

## Commit
- Hash: $HASH
- Autor: $author
- Mensagem: $msg

## Diff
$(git show --stat HEAD)

## Mudanças
$(git diff HEAD^ HEAD)
"@ | Out-File -Encoding UTF8 $File

    Write-Output "[post-commit] Checkpoint gerado em: $File"
}
